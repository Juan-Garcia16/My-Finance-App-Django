{% extends 'base.html' %} 

{% block content %}
<div class="flex flex-1 justify-center py-5">
  <div
    class="layout-content-container flex flex-col w-full max-w-7xl flex-1 px-4 sm:px-6 lg:px-8 min-w-0"
  >
    <div class="flex flex-wrap items-center justify-between gap-4 py-6 pt-2">
      <div class="flex min-w-72 flex-col gap-2">
        <h2
          class="text-[#34495e] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]"
        >
          Transacciones
      </h2>
        <p
          class="text-[#636f88] dark:text-gray-400 text-base font-normal leading-normal"
        >
          Visualiza y gestiona tus movimientos financieros.
        </p>
      </div>
      <a href="{% url 'transactions:create' %}" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-5 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-opacity-90 transition-colors">
        <span class="material-symbols-outlined">add</span>
        <span class="truncate">Agregar Transacción</span>
      </a>
    </div>
    <div class="flex flex-col gap-4 py-3">
      <div class="flex flex-wrap items-center gap-4">
        <div class="flex-grow">
          <label class="flex flex-col min-w-40 h-12 w-full">
            <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
              <div class="text-[#636f88] dark:text-gray-400 flex border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark items-center justify-center pl-4 rounded-l-lg border-r-0">
                <span class="material-symbols-outlined">search</span>
              </div>
              <input id="tx-search"
                class="form-input flex w-full min-w-0 max-w-[520px] flex-1 resize-none overflow-hidden rounded-lg text-[#34495e] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark h-full placeholder:text-[#636f88] dark:placeholder:text-gray-500 px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                placeholder="Buscar transacciones..."
                value=""
              />
            </div>
          </label>
        </div>
        <div class="flex gap-3 overflow-x-auto items-center">
          <div class="flex items-center gap-2">
            <label class="text-sm text-[#34495e] dark:text-gray-300">Desde</label>
            <input id="tx-date-from" type="date" class="rounded-lg border border-gray-200 dark:border-gray-700 px-2 py-1 bg-white dark:bg-background-dark text-sm" />
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-[#34495e] dark:text-gray-300">Hasta</label>
            <input id="tx-date-to" type="date" class="rounded-lg border border-gray-200 dark:border-gray-700 px-2 py-1 bg-white dark:bg-background-dark text-sm" />
          </div>
          <div class="flex items-center gap-2">
            <label for="tx-category-filter" class="text-sm text-[#34495e] dark:text-gray-300">Categoría</label>
            <select id="tx-category-filter" class="rounded-lg border border-gray-200 dark:border-gray-700 px-2 py-1 bg-white dark:bg-background-dark text-sm min-w-[140px]">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <label for="tx-type-filter" class="text-sm text-[#34495e] dark:text-gray-300">Tipo</label>
            <select id="tx-type-filter" class="rounded-lg border border-gray-200 dark:border-gray-700 px-2 py-1 bg-white dark:bg-background-dark text-sm min-w-[110px]">
              <option value="">Todos</option>
              <option value="ingreso">Ingreso</option>
              <option value="gasto">Gasto</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="py-3 @container">
      <div
        class="flex overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark min-w-0"
      >
        <table class="w-full table-fixed">
          <thead>
            <tr class="bg-gray-50 dark:bg-gray-800/50">
              <th
                class="px-6 py-4 text-left text-[#34495e] dark:text-gray-300 text-xs font-medium uppercase tracking-wider"
              >
                Tipo
              </th>
              <th
                class="px-6 py-4 text-left text-[#34495e] dark:text-gray-300 text-xs font-medium uppercase tracking-wider"
              >
                Categoría
              </th>
              <th
                class="px-6 py-4 text-left text-[#34495e] dark:text-gray-300 text-xs font-medium uppercase tracking-wider"
              >
                Monto
              </th>
              <th
                class="px-6 py-4 text-left text-[#34495e] dark:text-gray-300 text-xs font-medium uppercase tracking-wider"
              >
                Fecha
              </th>
              <th
                class="px-6 py-4 text-left text-[#34495e] dark:text-gray-300 text-xs font-medium uppercase tracking-wider"
              >
                Descripción
              </th>
              <th
                class="px-6 py-4 text-left text-[#34495e] dark:text-gray-300 text-xs font-medium uppercase tracking-wider"
              >
                Acciones
              </th>
            </tr>
          </thead>
          <tbody>
            {% for tx in transactions %}
            <tr class="border-t border-t-gray-200 dark:border-t-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/40"
              data-categoria="{{ tx.categoria.nombre|escape }}"
              data-tipo="{{ tx.tipo_transaccion }}"
              data-fecha="{{ tx.fecha }}"
              data-descripcion="{{ tx.descripcion|default:''|escape }}"
              data-monto="{{ tx.monto }}"
            >
              <td class="h-[72px] px-6 py-4 whitespace-nowrap">
                {% if tx.tipo_transaccion == 'ingreso' %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#27ae60]/10 text-[#27ae60]">Ingreso</span>
                {% else %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400">Gasto</span>
                {% endif %}
              </td>
              <td class="h-[72px] px-6 py-4 whitespace-nowrap text-[#34495e] dark:text-gray-300 text-sm font-normal">
                <div class="flex items-center gap-3">
                  <span class="w-3 h-3 rounded-full category-color" data-color="{{ tx.categoria.color|escape }}" aria-hidden="true" style="background: transparent;"></span>
                  <span class="truncate">{{ tx.categoria.nombre }}</span>
                </div>
              </td>
              <td class="h-[72px] px-6 py-4 whitespace-nowrap text-sm font-medium {% if tx.tipo_transaccion == 'ingreso' %}text-[#27ae60]{% else %}text-red-600{% endif %}">
                {% if tx.tipo_transaccion == 'ingreso' %}+{{ tx.monto_display }}{% else %}-{{ tx.monto_display }}{% endif %}
              </td>
              <td class="h-[72px] px-6 py-4 whitespace-nowrap text-[#636f88] dark:text-gray-400 text-sm font-normal">{{ tx.fecha }}</td>
              <td class="h-[72px] px-6 py-4 text-[#636f88] dark:text-gray-400 text-sm font-normal">
                <div class="truncate max-w-full" title="{{ tx.descripcion }}">{{ tx.descripcion }}</div>
              </td>
              <td class="h-[72px] px-6 py-4 whitespace-nowrap text-[#636f88] dark:text-gray-400 text-sm font-bold leading-normal tracking-[0.015em]">
                <div class="flex items-center gap-4">
                  <a href="{% url 'transactions:edit' tx.tipo_transaccion tx.pk %}" class="text-gray-500 hover:text-blue-500 dark:text-gray-400"">
                    <span class="material-symbols-outlined text-xl">edit</span>
                  </a>
                  <form method="post" action="{% url 'transactions:delete' tx.tipo_transaccion tx.pk %}" onsubmit="return confirm('Eliminar transacción?');">
                    {% csrf_token %}
                    <button type="submit" class="text-[#34495e] dark:text-gray-300 hover:text-red-500">
                      <span class="material-symbols-outlined text-xl">delete</span>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="px-6 py-4 text-sm text-gray-600">No hay transacciones todavía.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.category-color').forEach(function(el){
      var color = el.dataset.color;
      if(color){
        try{ el.style.background = color; }catch(e){}
      }
    });
      // Build category filter options from table rows
      const rows = Array.from(document.querySelectorAll('tbody tr[data-categoria]'));
      const catSelect = document.getElementById('tx-category-filter');
      const cats = new Set();
      rows.forEach(r=>{ const c=r.dataset.categoria||''; if(c) cats.add(c); });
      Array.from(cats).sort().forEach(c=>{
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c; catSelect.appendChild(opt);
      });

      const searchInput = document.getElementById('tx-search');
      const typeSelect = document.getElementById('tx-type-filter');
      const dateFrom = document.getElementById('tx-date-from');
      const dateTo = document.getElementById('tx-date-to');

      function parseDate(v){ if(!v) return null; const d=new Date(v); return isNaN(d)?null:d; }

      function matchRow(r){
        const s = (searchInput.value||'').trim().toLowerCase();
        const cat = (catSelect.value||'').trim();
        const tipo = (typeSelect.value||'').trim();
        const from = parseDate(dateFrom.value);
        const to = parseDate(dateTo.value);

        const rc = (r.dataset.categoria||'').toLowerCase();
        const rd = (r.dataset.descripcion||'').toLowerCase();
        const rt = (r.dataset.tipo||'').toLowerCase();
        const rf = r.dataset.fecha || '';

        if(s){ if(!(rc.indexOf(s)!==-1 || rd.indexOf(s)!==-1 || (r.dataset.monto||'').indexOf(s)!==-1)) return false; }
        if(cat){ if(rc !== cat.toLowerCase()) return false; }
        if(tipo){ if(rt !== tipo.toLowerCase()) return false; }
        if(from || to){
          const d = parseDate(rf);
          if(!d) return false;
          if(from && d < from) return false;
          if(to && d > to) return false;
        }
        return true;
      }

      function applyFilters(){
        rows.forEach(r=>{ if(matchRow(r)) r.style.display=''; else r.style.display='none'; });
      }

      [searchInput, catSelect, typeSelect, dateFrom, dateTo].forEach(el=>{ if(el) el.addEventListener(el.tagName==='INPUT' && el.type==='text'? 'input':'change', applyFilters); if(el && el.tagName==='INPUT' && el.type==='text') el.addEventListener('input', applyFilters); });
      // also filter on typing in search
      if(searchInput) searchInput.addEventListener('input', applyFilters);
  });
</script>
{% endblock %}
